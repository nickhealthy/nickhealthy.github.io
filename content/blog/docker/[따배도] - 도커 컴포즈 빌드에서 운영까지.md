---
title: '[ë”°ë°°ë„] - ë„ì»¤ ì»´í¬ì¦ˆ ë¹Œë“œì—ì„œ ìš´ì˜ê¹Œì§€'
date: 2021-08-21 14:52:30
category: 'ğŸ³ docker'
thumbnail: { thumbnailSrc }
tags: [docker, linux]
draft: false
---

ë„ì»¤ ì»´í¬ì¦ˆë¥¼ ì‚¬ìš©í•´ë³´ê³  ìµí˜€ë´…ì‹œë‹¤!

## ë„ì»¤ ì»´í¬ì¦ˆê°€ ë¬´ì—‡ì¸ê°€

- **<u>ì—¬ëŸ¬ ì»¨í…Œì´ë„ˆë¥¼ ì¼ê´„ì ìœ¼ë¡œ ì •ì˜í•˜ê³  ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” íˆ´</u>**
  - í•˜ë‚˜ì˜ ì„œë¹„ìŠ¤ë¥¼ ìš´ì˜í•˜ê¸° ìœ„í•´ì„œëŠ” ì—¬ëŸ¬ ê°œì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ë™ì‘í•´ì•¼ í•¨
  - ì»¨í…Œì´ë„ˆí™” ëœ ì• í”Œë¦¬ì¼€ì´ì…˜ë“¤ì„ í†µí•© ê´€ë¦¬í•  ìˆ˜ ìˆìŒ
  - YAML íŒŒì¼ í˜•ì‹ì˜ ì •ì˜ë¥¼ í†µí•´ ë„ì»¤ íŒŒì¼ë“¤ì„ ì •ì˜í•˜ê³  ì‚¬ìš©
    - ë˜ëŠ” ë„ì»¤ ì»´í¬ì¦ˆì˜ `image` ëª…ë ¹ì–´ë¥¼ í†µí•´ `docker run` ëª…ë ¹ì–´ì²˜ëŸ¼ ë°”ë¡œ ì‹¤í–‰ë„ ê°€ëŠ¥

### ì»´í¬ì¦ˆ YAML íŒŒì¼ ëª…ë ¹ì–´ ì •ë¦¬

- `version` : compose ë²„ì „.
  - ë²„ì „ì— ë”°ë¼ ì§€ì› ë¬¸ë²•ì´ ë‹¤ë¦„
- `services` : ì»´í¬ì¦ˆë¥¼ ì´ìš©í•´ì„œ ì‹¤í–‰í•  ì»¨í…Œì´ë„ˆ ì˜µì…˜ì„ ì •ì˜
- `build` : ë¹Œë“œí•  ë„ì»¤ íŒŒì¼ì˜ ìœ„ì¹˜
- `image` : composeë¥¼ í†µí•´ ì‹¤í–‰í•  ì´ë¯¸ì§€ë¥¼ ì§€ì •
  - ë„ì»¤ íŒŒì¼ ì •ì˜ ì—†ì´ `run` ëª…ë ¹ì–´ë¥¼ í†µí•´ imageë¥¼ í—ˆë¸Œì—ì„œ ë°”ë¡œ pullí•´ì„œ ëŒë¦¬ëŠ” ì—­í• ê³¼ ë¹„ìŠ·
- `command` : ì»¨í…Œì´ë„ˆì—ì„œ ì‹¤í–‰ë  ëª…ë ¹ì–´ ì§€ì •
- `port` : ì»¨í…Œì´ë„ˆê°€ ê³µê°œí•˜ëŠ” í¬íŠ¸ë¥¼ ë‚˜ì—´
- `link` : ë‹¤ë¥¸ ì»¨í…Œì´ë„ˆì™€ ì—°ê³„í•  ë•Œ ì—°ê³„í•  ì»¨í…Œì´ë„ˆë¥¼ ì§€ì •
- `expose` : í¬íŠ¸ë¥¼ ë§í¬ë¡œ ì—°ê³„ëœ ì»¨í…Œì´ë„ˆì—ê²Œë§Œ ê³µê°œí•  í¬íŠ¸
- `volumes` : ì»¨í…Œì´ë„ˆì— ë³¼ë¥¨ì„ ë§ˆìš´ë“œ
- `environment` : ì»¨í…Œì´ë„ˆì— ì ìš©í•  í™˜ê²½ë³€ìˆ˜ë¥¼ ì •ì˜
- `restart` : ì»¨í…Œì´ë„ˆê°€ ì¢…ë£Œë  ë•Œ ì ìš©í•  restart ì •ì±…
  - `no` : default ê°’ - ì¬ì‹œì‘ ë˜ì§€ ì•ŠìŒ
  - `always` : ì»¨í…Œì´ë„ˆë¥¼ ìˆ˜ë™ìœ¼ë¡œ ë„ê¸° ì „ê¹Œì§€ í•­ìƒ ì¬ì‹œì‘
  - `on-failure` : ì˜¤ë¥˜ê°€ ìˆì„ ì‹œì— ì¬ì‹œì‘
- `depends_on` : **<u>ì»¨í…Œì´ë„ˆ ê°„ì˜ ì¢…ì†ì„±ì„ ì •ì˜, ì •ì˜í•œ ì»¨í…Œì´ë„ˆê°€ ë¨¼ì € ë™ì‘</u>**

## ë„ì»¤ ì»´í¬ì¦ˆ ì„¤ì¹˜

- ê³µì‹ ë˜í¼ëŸ°ìŠ¤ í™•ì¸

```bash
$ sudo curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
$ sudo chmod +x /usr/local/bin/docker-compose
$ sudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose
$ docker-compose --version
```

## ë„ì»¤ ì»´í¬ì¦ˆ ì‹¤ìŠµ 1

Flask, Redis ì»¨í…Œì´ë„ˆë¥¼ ë„ì»¤ ì»´í¬ì¦ˆë¥¼ í†µí•´ ì‹¤í–‰ì‹œì¼œ ë´…ì‹œë‹¤.

<div class="quote-block">
<div class="quote-block__emoji">ğŸ’¡</div>
<div class="quote-block__content" markdown=1>

ì‹¤ìŠµ ì „ ì•Œì•„ë‘ê¸°!

ë„ì»¤ ì»´í¬ì¦ˆëŠ” ymlíŒŒì¼ ìœ„ì¹˜ê°€ ìˆëŠ” ê³³ì—ì„œ ì‹¤í–‰ì„ í•´ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤.  
ë”°ë¼ì„œ ë””ë ‰í† ë¦¬ ìƒì„± í›„, ë„ì»¤ íŒŒì¼ ì •ì˜, ì»´í¬ì¦ˆ íŒŒì¼ ì •ì˜ ë° ì‹¤í–‰ì„ í•˜ëŠ” ìˆœì„œë¥¼ ì¶”ì²œí•©ë‹ˆë‹¤.

</div>
</div>

- í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ìƒì„±

```bash
$ mkdir composetest
$ cd composetest
```

- íŒŒì´ì¬ [app.py] íŒŒì¼ ìƒì„± - Flask ì´ìš©

```python
cat > app.py

import time

import redis
from flask import Flask

app = Flask(__name__)
cache = redis.Redis(host='redis', port=6379)

def get_hit_count():
    retries = 5
    while True:
        try:
            return cache.incr('hits')
        except redis.exceptions.ConnectionError as exc:
            if retries == 0:
                raise exc
            retries -= 1
            time.sleep(0.5)

@app.route('/')
def hello():
    count = get_hit_count()
    return 'Hello World! I have been seen {} times.\n'.format(count)

```

- íŒŒì´ì¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ ê´€ë¦¬ [requirements.txt] íŒŒì¼ ìƒì„±

```python
cat > requirements.txt
flask
redis

```

- ë„ì»¤ íŒŒì¼ ìƒì„±

```dockerfile
FROM python:3.7-alpine
WORKDIR /code
ENV FLASK_APP=app.py
ENV FLASK_RUN_HOST=0.0.0.0
RUN apk add --no-cache gcc musl-dev linux-headers
COPY requirements.txt requirements.txt
RUN pip install -r requirements.txt
EXPOSE 5000
COPY . .
CMD ["flask", "run"]
```

- ë„ì»¤ ì»´í¬ì¦ˆ [docker-compose.yml] íŒŒì¼ ìƒì„±

```yaml
version: '3.9'
services:
  web:
    build: .
    ports:
      - '5000:5000'
  redis:
    image: 'redis:alpine'
```

- ë„ì»¤ ì»´í¬ì¦ˆ yaml íŒŒì¼ ë¬¸ë²• ì²´í¬

```bash
$ docker-compose config
```

- ë„ì»¤ ì»´í¬ì¦ˆ ì‹¤í–‰

```bash
$ docker-compose up
```

![1  docker-compose up í™•ì¸](https://user-images.githubusercontent.com/66216102/130312075-82a37b2f-8d2a-4235-b676-648112f4f785.JPG)

Flask, Redis ì»¨í…Œì´ë„ˆë¥¼ í†µí•´ ì˜ ì‹¤í–‰ëœ ëª¨ìŠµì…ë‹ˆë‹¤.

- ë„ì»¤ ì»´í¬ì¦ˆ yaml íŒŒì¼ì— ë³¼ë¥¨ ë§ˆìš´íŠ¸ ì¶”ê°€

```bash
version: "3.9"
services:
  web:
    build: .
    ports:
      - "5000:5000"
    # ------ì¶”ê°€--------
    volumes:
      - .:/code
    environment:
      FLASK_ENV: development
    # -----------------
  redis:
    image: "redis:alpine"
```

- ì´ë²ˆì—ëŠ” ë„ì»¤ ì»´í¬ì¦ˆë¥¼ ë°±ê·¸ë¼ìš´ë“œë¡œ ì‹¤í–‰

```bash
$ docker-compose up -d
```

- [app.py] íŒŒì¼ì„ ìˆ˜ì • ì‹œ, ë³¼ë¥¨ ë§ˆìš´íŠ¸ë¥¼ í†µí•´ì„œ ë°”ë¡œ ì»¨í…Œì´ë„ˆì— ë°˜ì˜ë˜ëŠ” ëª¨ìŠµì„ í™•ì¸

```python
$ vi app.py
...
return Hello Docker!
...
```

![2  volume ì‚¬ìš©](https://user-images.githubusercontent.com/66216102/130312076-ebed45f5-ca43-4270-9332-f861515b7e93.JPG)

- `scale` ëª…ë ¹ì–´ë¥¼ í†µí•´ redis ì»¨í…Œì´ë„ˆ ëŠ˜ë¦¬ê¸°

```bash
$ docker-compose scale redis=3
```

![3  redis ìŠ¤ì¼€ì¼ì•„ì›ƒ](https://user-images.githubusercontent.com/66216102/130312077-a1156cd0-43a3-4a92-af14-28dbaf36b6ca.JPG)

- `run` ëª…ë ¹ì–´ë¥¼ í†µí•´ `docker exec` ëª…ë ¹ì–´ì²˜ëŸ¼ ëª…ë ¹ ê²°ê³¼ë¥¼ ë°›ì•„ì˜¤ê¸°
  - web ì»¨í…Œì´ë„ˆì— env ëª…ë ¹ì–´ë¥¼ ë‚ ë¦° ê²ƒê³¼ ë™ì¼

![4  docker-compose run](https://user-images.githubusercontent.com/66216102/130312078-773a180b-8af6-4b96-af9c-39b2b0d3aa8d.JPG)

## ë„ì»¤ ì»´í¬ì¦ˆ ì‹¤ìŠµ 2

wordpressì™€ mysql ì»¨í…Œì´ë„ˆë¥¼ ë„ì»¤ ì»´í¬ì¦ˆë¥¼ í†µí•´ ì‹¤í–‰ì‹œì¼œ ë´…ì‹œë‹¤.

> wordpressì˜ ë™ì‘ ë°©ì‹ê³¼ êµ¬ì„± ë‚´ìš©ì€ ë„ì»¤ network í¬ìŠ¤íŒ… or ê³µì‹ ë˜í¼ëŸ°ìŠ¤ ì°¸ê³ 

- í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ìƒì„±

```bash
$ mkdir wordpress
$ cd wordpress
```

- ë„ì»¤ ì»´í¬ì¦ˆ [docker-compose.yml] íŒŒì¼ ìƒì„±
  - depends_on : db ì»¨í…Œì´ë„ˆ ì´ë¦„ì„ ê°€ì§„ ì„œë¹„ìŠ¤ê°€ ì‹¤í–‰ëœ í›„, wordpress ì»¨í…Œì´ë„ˆ ì‹¤í–‰
  - volumes : mysql ë°ì´í„°ì™€ wordpress_data ë³¼ë¥¨ ë§ˆìš´íŠ¸

```yaml
version: '3.9'

services:
  db:
    image: mysql:5.7
    volumes:
      - db_data:/var/lib/mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: somewordpress
      MYSQL_DATABASE: wordpress
      MYSQL_USER: wordpress
      MYSQL_PASSWORD: wordpress

  wordpress:
    depends_on:
      - db
    image: wordpress:latest
    volumes:
      - wordpress_data:/var/www/html
    ports:
      - '8080:80'
    restart: always
    environment:
      WORDPRESS_DB_HOST: db:3306
      WORDPRESS_DB_USER: wordpress
      WORDPRESS_DB_PASSWORD: wordpress
      WORDPRESS_DB_NAME: wordpress
volumes:
  db_data: {}
  wordpress_data: {}
```

- ë„ì»¤ ì»´í¬ì¦ˆ ì‹¤í–‰

```bash
$ docker-compose up -d
```

- wordpressê°€ ìƒì„±ëœ ê²ƒì„ í™•ì¸

![5  wordpress ìƒì„±](https://user-images.githubusercontent.com/66216102/130312079-a23ce51f-2bcf-4ea1-8585-978510f587e4.JPG)

- ë³¼ë¥¨ ë§ˆìš´íŠ¸ë¥¼ í™•ì¸
  - `'/var/lib/docker/volumes/í´ë”ëª…/ë³¼ë¥¨ëª…/_data'` í˜•íƒœë¡œ í‘œì‹œê°€ ë©ë‹ˆë‹¤.

```bash
$ docker volume inspect ë³¼ë¥¨ ë°ì´í„° ì´ë¦„
```

![6  volume í™•ì¸](https://user-images.githubusercontent.com/66216102/130312080-4a760511-da7f-4dee-87d0-b492018ff13a.JPG)

- í•´ë‹¹ ê²½ë¡œë¡œ ì§„ì…í•´ì„œ í™•ì¸
  - root ê³„ì • ì ‘ì† í•„ìš”
  - mysqlê³¼ wordpressì˜ ë°ì´í„°ê°€ ìŒ“ì—¬ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![6-1  volume í™•ì¸](https://user-images.githubusercontent.com/66216102/130312081-324791e4-9b13-4d11-837a-a153c6e2f5c2.JPG)

- ë„ì»¤ ì»´í¬ì¦ˆ ì •ë¦¬
  - `--volumes` ì¶”ê°€ ì˜µì…˜ì„ í†µí•´ ë³¼ë¥¨ë§ˆìš´íŠ¸ê¹Œì§€ ì •ë¦¬ëœ ëª¨ìŠµ

```bash
$ docker-compose down --volume
```

![7  ìµœì¢…](https://user-images.githubusercontent.com/66216102/130312082-fe218b85-567d-481d-a253-8293f3372d85.JPG)

## Reference

[ë„ì»¤ì»´í¬ì¦ˆ ì„¤ì¹˜](https://docs.docker.com/compose/install/)
