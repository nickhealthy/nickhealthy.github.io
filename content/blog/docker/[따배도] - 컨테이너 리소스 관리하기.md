---
title: '[ë”°ë°°ë„] - ì»¨í…Œì´ë„ˆ ë¦¬ì†ŒìŠ¤ ê´€ë¦¬í•˜ê¸°'
date: 2021-07-30 23:07:30
category: 'ğŸ³ docker'
thumbnail: { thumbnailSrc }
tags: [docker, linux]
draft: false
---

ì»¨í…Œì´ë„ˆ ë¦¬ì†ŒìŠ¤ ê´€ë¦¬ ëª…ë ¹ì–´ë¥¼ ë°°ì›Œë´…ì‹œë‹¤.

## ì»¨í…Œì´ë„ˆ í•˜ë“œì›¨ì–´ ë¦¬ì†ŒìŠ¤ ì œí•œ

- ê¸°ë³¸ì ìœ¼ë¡œ ì»¨í…Œì´ë„ˆëŠ” í˜¸ìŠ¤íŠ¸ í•˜ë“œì›¨ì–´ ë¦¬ì†ŒìŠ¤ì˜ ì‚¬ìš© ì œí•œì„ ë°›ì§€ ì•ŠìŠµë‹ˆë‹¤.
  - <u>ì»¨í…Œì´ë„ˆì˜ ìì›ì„ ì ì ˆí•˜ê²Œ ì œí•œí•´ì•¼ íš¨ìœ¨ì ì¸ ìš´ì˜ì„ ì‹¤í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</u>
  - `docker run --help` ëª…ë ¹ì–´ë¥¼ í†µí•´ CPU, Memory, Disk I/Oë¥¼ ì œí•œí•  ìˆ˜ ìˆìŒ

### ë©”ëª¨ë¦¬ ë¦¬ì†ŒìŠ¤ ì œí•œ

- ì œí•œ ë‹¨ìœ„ëŠ” `b, k, m, g` ë¡œ í• ë‹¹
- `--memory, -m` : ì»¨í…Œì´ë„ˆê°€ ì‚¬ìš©í•  ë•Œ ìµœëŒ€ ë©”ëª¨ë¦¬ ì–‘ì„ ì§€ì •
- `--memory-swap` : ì»¨í…Œì´ë„ˆê°€ ì‚¬ìš©í•  ìŠ¤ì™‘ ë©”ëª¨ë¦¬ ì˜ì—­ì— ëŒ€í•œ ì„¤ì •
  - ë©”ëª¨ë¦¬+**ìŠ¤ì™‘ ìƒëµ ì‹œ ë©”ëª¨ë¦¬ì˜ 2ë°°ê°€ ì„¤ì •ë¨**
- `--memory-reservation` : --memory ê°’ë³´ë‹¤ ì ì€ ê°’ìœ¼ë¡œ êµ¬ì„±í•˜ëŠ” ì†Œí”„íŠ¸ ì œí•œ ê°’ ì„¤ì •
- `--oom-kill-disable` : OOM Kilerê°€ í”„ë¡œì„¸ìŠ¤ kill í•˜ì§€ ëª»í•˜ë„ë¡ ë³´í˜¸

### CPU ë¦¬ì†ŒìŠ¤ ì œí•œ

- `--cpus` : ì»¨í…Œì´ë„ˆì— í• ë‹¹í•  CPU core ìˆ˜ë¥¼ ì§€ì •
- `--cpuset-cpus` : ì»¨í…Œì´ë„ˆê°€ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” CPUë‚˜ ì½”ì–´ë¥¼ í• ë‹¹. cpu indexëŠ” 0ë¶€í„°.
- `--cpu-share` : ì»¨í…Œì´ë„ˆê°€ ì‚¬ìš©í•˜ëŠ” CPU ë¹„ì¤‘ì„ 1024 ê°’ì„ ê¸°ë°˜ìœ¼ë¡œ ì„¤ì •
  - --cpu-share 2048 **ê¸°ë³¸ ê°’ë³´ë‹¤ ë‘ë°° ë§ì€ CPU ìì›ì„ í• ë‹¹**

### Block I/O ì œí•œ

- `--blkio-weight / blkio-weight-device` : Block IOì˜ Quotaë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìœ¼ë©° 100~1000ê¹Œì§€ ì„ íƒ, default 500
- `--device-read/write-bps` : íŠ¹ì • ë””ë°”ì´ìŠ¤ì— ëŒ€í•œ ì½ê¸°ì™€ ì“°ê¸° ì‘ì—…ì˜ ì´ˆë‹¹ ì œí•œì„ kb, mb, gb ë‹¨ìœ„ë¡œ ì„¤ì •
- `--device-read/write-iops` : ì»¨í…Œì´ë„ˆì˜ read/write ì†ë„ì˜ ì¿¼í„°ë¥¼ ì„¤ì •í•œë‹¤.

## ì»¨í…Œì´ë„ˆ ì‚¬ìš© ë¦¬ì†ŒìŠ¤ë¥¼ í™•ì¸í•˜ëŠ” ëª¨ë‹ˆí„°ë§ íˆ´

### docker monitoring commands

- docker stat : ì‹¤í–‰ì¤‘ì¸ ì»¨í…Œì´ë„ˆì˜ ëŸ°íƒ€ì„ í†µê³„ë¥¼ í™•ì¸
  - `docker stats [OPTIONS] [CONTAINER..]`
- docker event : ë„ì»¤ í˜¸ìŠ¤íŠ¸ì˜ ì‹¤ì‹œê°„ event ì •ë³´ë¥¼ ìˆ˜ì§‘í•´ì„œ ì¶œë ¥
- cAdvisor : êµ¬ê¸€ì—ì„œ ë§Œë“¬

## ì‹¤ìŠµ

### ë¶€í•˜í…ŒìŠ¤íŠ¸ë¥¼ í†µí•œ ë¦¬ì†ŒìŠ¤ ì œí•œ í•˜ê¸°

> ë¶€í•˜í…ŒìŠ¤íŠ¸ì—ì„œ ì‚¬ìš©í•  ì»¨í…Œì´ë„ˆëŠ” `stress` íˆ´ì„ ì‚¬ìš©

- stress ë„ì»¤ íŒŒì¼ ë§Œë“¤ê¸°

```dockerfile
FROM debian
RUN apt-get update; apt-get install stress -y
CMD ["/bin/sh", "-c", "stress -c 2"]
```

- ë„ì»¤ íŒŒì¼ ë¹Œë“œ

```bash
$ docker build -t stress .
```

### ë©”ëª¨ë¦¬ ë¦¬ì†ŒìŠ¤ ì œí•œ

<div class="quote-block">
<div class="quote-block__emoji">ğŸ’¡</div>
<div class="quote-block__content" markdown=1>

Swap Memory

ëª¨ë“  ì»´í“¨í„° ìš´ì˜ì²´ì œì—ëŠ” ê°€ìƒë©”ëª¨ë¦¬ë¼ëŠ” ê²ƒì„ ì‚¬ìš©í•˜ê²Œ ë˜ëŠ”ë°  
ë¦¬ëˆ…ìŠ¤ì—ì„œ ê°€ìƒë©”ëª¨ë¦¬ë¥¼ **ìŠ¤ì™‘íŒŒì¼ì‹œìŠ¤í…œ**ì´ë¼ê³  í•©ë‹ˆë‹¤.

</div>
</div>

- swap ë©”ëª¨ë¦¬ ìš©ëŸ‰ ì œí•œì´ ì‹¤ì œ ë©”ëª¨ë¦¬ ì œí•œê³¼ ì–´ë–¤ ê´€ë ¨ì„±ì´ ìˆëŠ”ì§€ í™•ì¸í•´ë³¸ë‹¤.
  - `-m` : ë©”ëª¨ë¦¬ ì§€ì •
  - `--memory-swap` : ìŠ¤ì™‘ ë©”ëª¨ë¦¬ ì§€ì •
  - ì¦‰, ì•„ë˜ì˜ ì˜ˆì‹œëŠ” ì „ì²´ì ì¸ ë©”ëª¨ë¦¬ 100m ì¤‘ ìŠ¤ì™‘ ë©”ëª¨ë¦¬ë¥¼ 100ë¥¼ ì¤Œìœ¼ë¡œì¨ ìŠ¤ì™‘ ë©”ëª¨ë¦¬ëŠ” ì´ìš©í•  ìˆ˜ ì—†ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.(200m ë¥¼ ì§€ì •í•˜ì˜€ìœ¼ë©´ ìŠ¤ì™‘ë©”ëª¨ë¦¬ëŠ” 100ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê²ƒì„)
  - `stress --vm 1 --vm-bytes 90m -t 5s` : stress íˆ´ì˜ ëª…ë ¹ì–´ ì°¸ê³ 

```bash
$ docker run -m 100m --memory-swap 100m stress:latest stress --vm 1 --vm-bytes 90m -t 5s
```

- í• ë‹¹ ëœ ë©”ëª¨ë¦¬ë³´ë‹¤ ë†’ì€ ì‚¬ìš©ëŸ‰ì„ ì§€ì •í•˜ì˜€ì„ ë•Œ ì‹¤í–‰ ê²€ì¦
  - ì‹¤í–‰ì´ ë˜ì§€ ì•ŠëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŒ(`--vm-bytes 150m` ë¶€ë¶„ë•Œë¬¸ì—)

> ê°€ë” ì»¤ë„ì˜ ì„¤ì • ë¬¸ì œë¡œ ë©”ëª¨ë¦¬ ì œí•œ ì„¤ì •ì´ ì ìš©ì´ ì•ˆë˜ì–´ì„œ ì‹¤í–‰ì´ ë˜ëŠ” ê²½ìš°ê°€ ìˆëŠ”ë°,
>
> 1. root ì‚¬ìš©ìë¡œ ì§„ì… í›„ `/etc/default/grub` íŒŒì¼ ìˆ˜ì •
> 2. GRUB_CMDLINE_LINUX_DEFAULT="cgroup_enable=memory swapaccount=1" ëª…ë ¹ì–´ ì¶”ê°€
> 3. `update-grub` ëª…ë ¹ì–´ ì…ë ¥
> 4. `reboot` ëª…ë ¹ì–´ ì…ë ¥

```bash
$ docker run -m 100m --memory-swap 100m stress:latest stress --vm 1 --vm-bytes 150m -t 5s
```

### OOM-killer

<div class="quote-block">
<div class="quote-block__emoji">ğŸ’¡</div>
<div class="quote-block__content" markdown=1>

out-of-memory-killerë€?

ë¦¬ëˆ…ìŠ¤ì—ì„œëŠ” ì•ˆì •ì ì¸ ì„œë²„ ìš´ì˜ì„ ìœ„í•´ í˜¸ìŠ¤íŠ¸ ë©”ëª¨ë¦¬ê°€ ë¶€ì¡±í•˜ê²Œ ë˜ë©´ í”„ë¡œì„¸ìŠ¤ë¥¼ ê°•ì œ ì¢…ë£Œí•˜ê²Œ ë©ë‹ˆë‹¤.

</div>
</div>

- OOM-killerë¡œ ê°•ì œ ì¢…ë£Œë˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ `--oom-killer-disable=ture` ëª…ë ¹ì„ í†µí•´ í”„ë¡œì„¸ìŠ¤ ê°•ì œ ì¢…ë£Œë¥¼ ë°©ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
$ docker run -d -m 100M --name m4 --oom-kill-disable=true nginx
```

- `inspect` ëª…ë ¹ì–´ë¥¼ í†µí•´ ì»¨í…Œì´ë„ˆ ìƒì„¸ í™•ì¸
  - `"Memory": 104857600, "MemorySwap": 209715200,` : ìŠ¤ì™‘ë©”ëª¨ë¦¬ ë”°ë¡œ ì§€ì •ì„ ì•ˆí•´ì£¼ë‹ˆ ìë™ì ìœ¼ë¡œ 2ë°°ë¡œ ì‚°ì •ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  - `"OomKillDisable": true,` : OOM-killerê°€ ë¹„í™œì„±í™” ë˜ì—ˆìŠµë‹ˆë‹¤.

```bash
$ docker inspect m4
```

### CPU ë¦¬ì†ŒìŠ¤ ì œí•œ

## Reference

[swap ë©”ëª¨ë¦¬ ì„¤ëª…](https://m.blog.naver.com/PostView.naver?isHttpsRedirect=true&blogId=dudwo567890&logNo=130156450500)  
[swap ë©”ëª¨ë¦¬ ì„¤ì •](https://www.joinc.co.kr/w/man/12/docker/limits)  
[stress íˆ´ ëª…ë ¹ì–´](https://klero.tistory.com/entry/%EB%A6%AC%EB%88%85%EC%8A%A4-stress-%ED%88%B4%EC%9D%84-%ED%86%B5%ED%95%B4-CPU-Memory-%EC%8A%A4%ED%8A%B8%EB%A0%88%EC%8A%A4-%EB%B6%80%ED%95%98-%EC%A3%BC%EB%8A%94-%EB%B0%A9%EB%B2%95)
