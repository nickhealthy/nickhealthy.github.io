---
title: '[ë”°ë°°ë„] - ì»¨í…Œì´ë„ˆ ë¦¬ì†ŒìŠ¤ ê´€ë¦¬í•˜ê¸°'
date: 2021-07-30 23:07:30
category: 'ğŸ³ docker'
thumbnail: { thumbnailSrc }
tags: [docker, linux]
draft: false
---

ì»¨í…Œì´ë„ˆ ë¦¬ì†ŒìŠ¤ ê´€ë¦¬ ëª…ë ¹ì–´ë¥¼ ë°°ì›Œë´…ì‹œë‹¤.  
(ë©”ëª¨ë¦¬, CPU, Block I/O, cAdvisor)

## ì»¨í…Œì´ë„ˆ í•˜ë“œì›¨ì–´ ë¦¬ì†ŒìŠ¤ ì œí•œ

- ê¸°ë³¸ì ìœ¼ë¡œ ì»¨í…Œì´ë„ˆëŠ” í˜¸ìŠ¤íŠ¸ í•˜ë“œì›¨ì–´ ë¦¬ì†ŒìŠ¤ì˜ ì‚¬ìš© ì œí•œì„ ë°›ì§€ ì•ŠìŠµë‹ˆë‹¤.
  - <u>ì»¨í…Œì´ë„ˆì˜ ìì›ì„ ì ì ˆí•˜ê²Œ ì œí•œí•´ì•¼ íš¨ìœ¨ì ì¸ ìš´ì˜ì„ ì‹¤í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</u>
  - `docker run --help` ëª…ë ¹ì–´ë¥¼ í†µí•´ CPU, Memory, Disk I/Oë¥¼ ì œí•œí•  ìˆ˜ ìˆìŒ

### ë©”ëª¨ë¦¬ ë¦¬ì†ŒìŠ¤ ì œí•œ

- ì œí•œ ë‹¨ìœ„ëŠ” `b, k, m, g` ë¡œ í• ë‹¹
- `--memory, -m` : ì»¨í…Œì´ë„ˆê°€ ì‚¬ìš©í•  ë•Œ ìµœëŒ€ ë©”ëª¨ë¦¬ ì–‘ì„ ì§€ì •
- `--memory-swap` : ì»¨í…Œì´ë„ˆê°€ ì‚¬ìš©í•  ìŠ¤ì™‘ ë©”ëª¨ë¦¬ ì˜ì—­ì— ëŒ€í•œ ì„¤ì •
  - ë©”ëª¨ë¦¬+**ìŠ¤ì™‘ ìƒëµ ì‹œ ë©”ëª¨ë¦¬ì˜ 2ë°°ê°€ ì„¤ì •ë¨**
- `--memory-reservation` : --memory ê°’ë³´ë‹¤ ì ì€ ê°’ìœ¼ë¡œ êµ¬ì„±í•˜ëŠ” ì†Œí”„íŠ¸ ì œí•œ ê°’ ì„¤ì •
- `--oom-kill-disable` : OOM Kilerê°€ í”„ë¡œì„¸ìŠ¤ kill í•˜ì§€ ëª»í•˜ë„ë¡ ë³´í˜¸

### CPU ë¦¬ì†ŒìŠ¤ ì œí•œ

- `--cpus` : ì»¨í…Œì´ë„ˆì— í• ë‹¹í•  CPU core ìˆ˜ë¥¼ ì§€ì •
- `--cpuset-cpus` : ì»¨í…Œì´ë„ˆê°€ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” CPUë‚˜ ì½”ì–´ë¥¼ í• ë‹¹. cpu indexëŠ” 0ë¶€í„°.
- `--cpu-share` : ì»¨í…Œì´ë„ˆê°€ ì‚¬ìš©í•˜ëŠ” CPU ë¹„ì¤‘ì„ 1024 ê°’ì„ ê¸°ë°˜ìœ¼ë¡œ ì„¤ì •
  - --cpu-share 2048 **ê¸°ë³¸ ê°’ë³´ë‹¤ ë‘ë°° ë§ì€ CPU ìì›ì„ í• ë‹¹**

### Block I/O ì œí•œ

- `--blkio-weight / blkio-weight-device` : Block IOì˜ Quotaë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìœ¼ë©° 100~1000ê¹Œì§€ ì„ íƒ, default 500
- `--device-read/write-bps` : íŠ¹ì • ë””ë°”ì´ìŠ¤ì— ëŒ€í•œ ì½ê¸°ì™€ ì“°ê¸° ì‘ì—…ì˜ ì´ˆë‹¹ ì œí•œì„ kb, mb, gb ë‹¨ìœ„ë¡œ ì„¤ì •
- `--device-read/write-iops` : ì»¨í…Œì´ë„ˆì˜ read/write ì†ë„ì˜ ì¿¼í„°ë¥¼ ì„¤ì •í•œë‹¤.

## ì»¨í…Œì´ë„ˆ ì‚¬ìš© ë¦¬ì†ŒìŠ¤ë¥¼ í™•ì¸í•˜ëŠ” ëª¨ë‹ˆí„°ë§ íˆ´

### docker monitoring commands

- docker stat : ì‹¤í–‰ì¤‘ì¸ ì»¨í…Œì´ë„ˆì˜ ëŸ°íƒ€ì„ í†µê³„ë¥¼ í™•ì¸
  - `docker stats [OPTIONS] [CONTAINER..]`
- docker event : ë„ì»¤ í˜¸ìŠ¤íŠ¸ì˜ ì‹¤ì‹œê°„ event ì •ë³´ë¥¼ ìˆ˜ì§‘í•´ì„œ ì¶œë ¥
- cAdvisor : êµ¬ê¸€ì—ì„œ ë§Œë“¬

## ì‹¤ìŠµ

### ë¶€í•˜í…ŒìŠ¤íŠ¸ë¥¼ í†µí•œ ë¦¬ì†ŒìŠ¤ ì œí•œ í•˜ê¸°

> ë¶€í•˜í…ŒìŠ¤íŠ¸ì—ì„œ ì‚¬ìš©í•  ì»¨í…Œì´ë„ˆëŠ” `stress` íˆ´ì„ ì‚¬ìš©

- stress ë„ì»¤ íŒŒì¼ ë§Œë“¤ê¸°

```dockerfile
FROM debian
RUN apt-get update; apt-get install stress -y
CMD ["/bin/sh", "-c", "stress -c 2"]
```

- ë„ì»¤ íŒŒì¼ ë¹Œë“œ

```bash
$ docker build -t stress .
```

### ë©”ëª¨ë¦¬ ë¦¬ì†ŒìŠ¤ ì œí•œ

<div class="quote-block">
<div class="quote-block__emoji">ğŸ’¡</div>
<div class="quote-block__content" markdown=1>

Swap Memory

ëª¨ë“  ì»´í“¨í„° ìš´ì˜ì²´ì œì—ëŠ” ê°€ìƒë©”ëª¨ë¦¬ë¼ëŠ” ê²ƒì„ ì‚¬ìš©í•˜ê²Œ ë˜ëŠ”ë°  
ë¦¬ëˆ…ìŠ¤ì—ì„œ ê°€ìƒë©”ëª¨ë¦¬ë¥¼ **ìŠ¤ì™‘íŒŒì¼ì‹œìŠ¤í…œ**ì´ë¼ê³  í•©ë‹ˆë‹¤.

</div>
</div>

- swap ë©”ëª¨ë¦¬ ìš©ëŸ‰ ì œí•œì´ ì‹¤ì œ ë©”ëª¨ë¦¬ ì œí•œê³¼ ì–´ë–¤ ê´€ë ¨ì„±ì´ ìˆëŠ”ì§€ í™•ì¸í•´ë³¸ë‹¤.
  - `-m` : ë©”ëª¨ë¦¬ ì§€ì •
  - `--memory-swap` : ìŠ¤ì™‘ ë©”ëª¨ë¦¬ ì§€ì •
  - ì¦‰, ì•„ë˜ì˜ ì˜ˆì‹œëŠ” ì „ì²´ì ì¸ ë©”ëª¨ë¦¬ 100m ì¤‘ ìŠ¤ì™‘ ë©”ëª¨ë¦¬ë¥¼ 100ë¥¼ ì¤Œìœ¼ë¡œì¨ ìŠ¤ì™‘ ë©”ëª¨ë¦¬ëŠ” ì´ìš©í•  ìˆ˜ ì—†ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.(200m ë¥¼ ì§€ì •í•˜ì˜€ìœ¼ë©´ ìŠ¤ì™‘ë©”ëª¨ë¦¬ëŠ” 100ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê²ƒì„)
  - `stress --vm 1 --vm-bytes 90m -t 5s` : stress íˆ´ì˜ ëª…ë ¹ì–´ ì°¸ê³ 

```bash
$ docker run -m 100m --memory-swap 100m stress:latest stress --vm 1 --vm-bytes 90m -t 5s
```

- í• ë‹¹ ëœ ë©”ëª¨ë¦¬ë³´ë‹¤ ë†’ì€ ì‚¬ìš©ëŸ‰ì„ ì§€ì •í•˜ì˜€ì„ ë•Œ ì‹¤í–‰ ê²€ì¦
  - ì‹¤í–‰ì´ ë˜ì§€ ì•ŠëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŒ(`--vm-bytes 150m` ë¶€ë¶„ë•Œë¬¸ì—)

> ê°€ë” ì»¤ë„ì˜ ì„¤ì • ë¬¸ì œë¡œ ë©”ëª¨ë¦¬ ì œí•œ ì„¤ì •ì´ ì ìš©ì´ ì•ˆë˜ì–´ì„œ ì‹¤í–‰ì´ ë˜ëŠ” ê²½ìš°ê°€ ìˆëŠ”ë°,
>
> 1. root ì‚¬ìš©ìë¡œ ì§„ì… í›„ `/etc/default/grub` íŒŒì¼ ìˆ˜ì •
> 2. GRUB_CMDLINE_LINUX_DEFAULT="cgroup_enable=memory swapaccount=1" ëª…ë ¹ì–´ ì¶”ê°€
> 3. `update-grub` ëª…ë ¹ì–´ ì…ë ¥
> 4. `reboot` ëª…ë ¹ì–´ ì…ë ¥

```bash
$ docker run -m 100m --memory-swap 100m stress:latest stress --vm 1 --vm-bytes 150m -t 5s
```

### OOM-killer

<div class="quote-block">
<div class="quote-block__emoji">ğŸ’¡</div>
<div class="quote-block__content" markdown=1>

out-of-memory-killerë€?

ë¦¬ëˆ…ìŠ¤ì—ì„œëŠ” ì•ˆì •ì ì¸ ì„œë²„ ìš´ì˜ì„ ìœ„í•´ í˜¸ìŠ¤íŠ¸ ë©”ëª¨ë¦¬ê°€ ë¶€ì¡±í•˜ê²Œ ë˜ë©´ í”„ë¡œì„¸ìŠ¤ë¥¼ ê°•ì œ ì¢…ë£Œí•˜ê²Œ ë©ë‹ˆë‹¤.

</div>
</div>

- OOM-killerë¡œ ê°•ì œ ì¢…ë£Œë˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ `--oom-killer-disable=ture` ëª…ë ¹ì„ í†µí•´ í”„ë¡œì„¸ìŠ¤ ê°•ì œ ì¢…ë£Œë¥¼ ë°©ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
$ docker run -d -m 100M --name m4 --oom-kill-disable=true nginx
```

- `inspect` ëª…ë ¹ì–´ë¥¼ í†µí•´ ì»¨í…Œì´ë„ˆ ìƒì„¸ í™•ì¸
  - `"Memory": 104857600, "MemorySwap": 209715200,` : ìŠ¤ì™‘ë©”ëª¨ë¦¬ ë”°ë¡œ ì§€ì •ì„ ì•ˆí•´ì£¼ë‹ˆ ìë™ì ìœ¼ë¡œ 2ë°°ë¡œ ì‚°ì •ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  - `"OomKillDisable": true,` : OOM-killerê°€ ë¹„í™œì„±í™” ë˜ì—ˆìŠµë‹ˆë‹¤.

```bash
$ docker inspect m4
```

- ì»¨í…Œì´ë„ˆIDë¥¼ ì§ì ‘ ì¡°íšŒí•˜ëŠ” ë°©ì‹ìœ¼ë¡œ í™•ì¸
  - `oom_kill_disable` ì´ 1 ê°’ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

```bash
$ cat /sys/fs/cgroup/memory/docker/6b2d8b686ab6c9c43fb76fa1310ab3c16ea672f86980ed5d53394e42e7f7df26/memory.oom_control
```

![1  ë„ì»¤ ë¦¬ì†ŒìŠ¤ ì•„ì›ƒì˜¤ë¸Œë©”ëª¨ë¦¬](https://user-images.githubusercontent.com/66216102/127764046-5eb963cd-61d9-48b6-9e27-4947adbd10c2.JPG)

### CPU ë¦¬ì†ŒìŠ¤ ì œí•œ

- CPU-indexë¥¼ ì§€ì •í•´ì„œ ì»¨í…Œì´ë„ˆ ë™ì‘ì‹œí‚¤ê¸°(ì˜ˆë¥¼ ë“¤ì–´ 4ì½”ì–´ ì¤‘ në²ˆì§¸ ì½”ì–´ ì‚¬ìš©)

```bash
$ docker run --cpuset-cpus 1 --name c1 stress:latest stress --cpu 1
# 0-1 ë²ˆ ì¤‘ ìƒí™©ì— ë”°ë¼ì„œ ë‘ê°œ ì¤‘ í•˜ë‚˜ë¥¼ ì‚¬ìš©
$ docker run --cpuset-cpus 0-1 --name c1 stress:latest stress --cpu 1
```

> docker: Error response from daemon: Requested CPUs are not available - requested 1, available: 0.
>
> ìœ„ì™€ ê°™ì€ ì˜¤ë¥˜ê°€ ëœ¨ëŠ” ê²ƒì€ cpuê°€ 1ê°œ ë°–ì— ì—†ìœ¼ë¯€ë¡œ ëœ¨ê²Œ ë©ë‹ˆë‹¤.

- `htop` ëª…ë ¹ì–´ë¡œ CPU ì ìœ ìœ¨ í™•ì¸
  - í˜„ì¬ CPUê°€ í•˜ë‚˜ì´ë¯€ë¡œ CPU indexê°€ í•˜ë‚˜ë°–ì— ë³´ì´ì§€ ì•ŠëŠ” ìƒíƒœ

```bash
$ htop
```

![2  cpu ìì›ë¥  í™•ì¸](https://user-images.githubusercontent.com/66216102/127764051-fc4c4b76-c350-4816-991a-cc9c5bc4fedc.JPG)

- `--cpu-shares` ëª…ë ¹ì–´ë¥¼ ì´ìš©í•´ CPU ìƒëŒ€ì  ê°€ì¤‘ì¹˜ë¥¼ í• ë‹¹

```bash
$ docker run --cpu-shares 2048 --name cload1 -d stress:latest # ê°€ì¥ ì ìœ ìœ¨ ë†’ìŒ
$ docker run --name cload2 -d stress:latest # ì ìœ ìœ¨ ë³´í†µ(1024 ê¸°ë³¸ ê°’)
$ docker run -c 512 --name cload3 -d stress:latest # ì ìœ ìœ¨ ê°€ì¥ ë‚®ìŒ
```

- ëª¨ë‹ˆí„°ë§ íˆ´ì„ ì´ìš©í•´ í™•ì¸í•´ ë´…ì‹œë‹¤.
  - CPU 1ê°œë¥¼ ê¸°ì¤€ìœ¼ë¡œ _cload1 CPUëŠ” 55%, cload2 CPUëŠ” 27%, cload3 CPUëŠ” 13%_ ì ìœ ìœ¨ì„ ê°ê° í• ë‹¹ë˜ì–´ ìˆìŒ
  - ìƒëŒ€ì ìœ¼ë¡œ ë¹„ìœ¨ì„ ì¡°ì ˆí•˜ê³  ìˆìŠµë‹ˆë‹¤.

```bash
$ docker stats <ì»¨í…Œì´ë„ˆ ì´ë¦„ ìƒëµ ê°€ëŠ¥>
```

![3  cpu-shares ìì›ë¥  í™•ì¸](https://user-images.githubusercontent.com/66216102/127764052-a32a7dc9-f9b0-4257-ab31-73f249cf5cd1.JPG)

### Block I/O ì œí•œ

<div class="quote-block">
<div class="quote-block__emoji">ğŸ’¡</div>
<div class="quote-block__content" markdown=1>

ëª…ë ¹ì–´ë¥¼ í†µí•´ ë¦¬ëˆ…ìŠ¤ ìŠ¤í† ë¦¬ì§€ ë””ë°”ì´ìŠ¤ ì •ë³´ë¥¼ ì¶œë ¥í•˜ëŠ” ë°©ë²•

`lsblk` ëª…ë ¹ì–´ë¥¼ í†µí•´ ë¦¬ëˆ…ìŠ¤ ë””ë°”ì´ìŠ¤ ì •ë³´ë¥¼ ì¶œë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

</div>
</div>

- `lsblk` ëª…ë ¹ì–´ë¥¼ í†µí•´ ë¦¬ëˆ…ìŠ¤ ìŠ¤í† ë¦¬ì§€ ë””ë°”ì´ìŠ¤ ì •ë³´ í™•ì¸

```bash
$ lsblk
```

- ì»¨í…Œì´ë„ˆë¥¼ í•˜ë‚˜ ë§Œë“  ë’¤, ëª…ë ¹ì–´ë¥¼ í†µí•´ ì»¨í…Œì´ë„ˆ IOì˜ ì†ë„ë¥¼ ì¡°ì ˆ

```bash
$ docker run -it --rm --device-write-iops /dev/xvda:10 ubuntu:latest /bin/bash
# ì»¨í…Œì´ë„ˆ ì§„ì… í›„
$ dd if=/dev/zero of=file1 bs=1M count=10 oflag=direct
# ì»¨í…Œì´ë„ˆ ë‚˜ì˜¤ê¸°
$ exit
```

![4  block i,o ì†ë„ í™•ì¸](https://user-images.githubusercontent.com/66216102/127764054-c5e389ed-f1cb-4749-a172-09b8f2f59f5d.JPG)

- ì¡°ê¸ˆ ë” ë¹ ë¥¸ IO ì»¨í…Œì´ë„ˆë¥¼ ë§Œë“  ë’¤, ì†ë„ ë¹„êµ
  - <u>ìœ„ì˜ ì»¨í…Œì´ë„ˆëŠ” ì´ˆë‹¹ 10.4 MBë¥¼ ë§Œë“¤ì—ˆì§€ë§Œ, í•´ë‹¹ ì»¨í…Œì´ë„ˆëŠ” ì´ˆë‹¹ 254MB</u>ë¥¼ ë§Œë“¤ë©´ì„œ IO ì†ë„ê°€ ì¦ê°€í•œ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
$ docker run -it --rm --device-write-iops /dev/xvda:100 ubuntu:latest /bin/bash
# ì»¨í…Œì´ë„ˆ ì§„ì… í›„
$ dd if=/dev/zero of=file1 bs=1M count=10 oflag=direct
```

![5  block i,o ì†ë„ í™•ì¸](https://user-images.githubusercontent.com/66216102/127764056-c94ac39d-5b61-4c2a-81d7-ee54da856809.JPG)

### cAdvisor ì‹¤í–‰

- ì»¨í…Œì´ë„ˆ ì‹¤í–‰
  - ì°¸ê³ : ìŠ¤ì™‘ ë©”ëª¨ë¦¬ ë¯¸ì§€ì • ìƒíƒœì—ì„œ 500MB í• ë‹¹ë˜ì–´, ìŠ¤ì™‘ ë©”ëª¨ë¦¬ëŠ” 2ë°°ë¥¼ ê°€ì§€ê²Œ ë¨

```bash
$ docker run -it --rm --device-write-iops /dev/xvda:100 -m 500m --name c1 -d ubuntu:latest /bin/bash
```

- cAdvisor ì„¤ì¹˜ í›„, ì›¹ì—ì„œ GUI í™”ë©´ í™•ì¸
  - ì°¸ê³ : cAdvisorëŠ” êµ¬ê¸€ì—ì„œ ë§Œë“  ì»¨í…Œì´ë„ˆ ë¶„ì„ íˆ´ì…ë‹ˆë‹¤.
  - ì¿ ë²„ë„¤í‹°ìŠ¤ì˜ kubeletì—ì„œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

```bash
VERSION=v0.36.0 # use the latest release version from https://github.com/google/cadvisor/releases
sudo docker run \
  --volume=/:/rootfs:ro \
  --volume=/var/run:/var/run:ro \
  --volume=/sys:/sys:ro \
  --volume=/var/lib/docker/:/var/lib/docker:ro \
  --volume=/dev/disk/:/dev/disk:ro \
  --publish=8080:8080 \
  --detach=true \
  --name=cadvisor \
  --privileged \
  --device=/dev/kmsg \
  gcr.io/cadvisor/cadvisor:$VERSION
```

- cAdvisor ì ‘ì†í•˜ê¸°
  - ì›¹ ë¸Œë¼ìš°ì €ë¥¼ í†µí•´ ì ‘ì†ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

```bash
<í¼ë¸”ë¦­ ì•„ì´í”¼>:8080(í¬íŠ¸ë²ˆí˜¸)
```

## ì‹¤ìŠµ ê³¼ì œ

- mysql ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ì—¬
  1. ë©”ëª¨ë¦¬ 200m
  2. ìŠ¤ì™‘ë©”ëª¨ë¦¬ 300m
  3. CPU 1ê°œ ì‚¬ìš©í•œ í›„
  4. `docker stats` ëª…ë ¹ì–´ë¡œ ë¦¬ì†ŒìŠ¤ í™•ì¸

```bash
$ docker run --name db -d -p 3306:3306 -e MYSQL_ROOT_PASSWORD=pass -m 200m --memory-swap 300m --cpus 1 mysql:latest
# ìì› í™•ì¸
$ docker stats
```

![6  ë””ë¹„ìì›í™”ê¹…ã„´](https://user-images.githubusercontent.com/66216102/127764057-62a9cf3b-4982-4c03-803a-2d745fe82451.JPG)

## Reference

[swap ë©”ëª¨ë¦¬ ì„¤ëª…](https://m.blog.naver.com/PostView.naver?isHttpsRedirect=true&blogId=dudwo567890&logNo=130156450500)  
[swap ë©”ëª¨ë¦¬ ì„¤ì •](https://www.joinc.co.kr/w/man/12/docker/limits)  
[stress íˆ´ ëª…ë ¹ì–´](https://klero.tistory.com/entry/%EB%A6%AC%EB%88%85%EC%8A%A4-stress-%ED%88%B4%EC%9D%84-%ED%86%B5%ED%95%B4-CPU-Memory-%EC%8A%A4%ED%8A%B8%EB%A0%88%EC%8A%A4-%EB%B6%80%ED%95%98-%EC%A3%BC%EB%8A%94-%EB%B0%A9%EB%B2%95)  
[docker ìì› í• ë‹¹ ì—ëŸ¬](https://devnot.tistory.com/96)  
[ë¦¬ëˆ…ìŠ¤ ìŠ¤í† ë¦¬ì§€ ë””ë°”ì´ìŠ¤ ì¶œë ¥ ëª…ë ¹ì–´](https://www.lesstif.com/lpt/lsblk-106856724.html)  
[cAdvisor-github](https://github.com/google/cadvisor)
