---
title: '[따배도] - 컨테이너 네트워크'
date: 2021-08-03 23:32:30
category: '🐳 docker'
thumbnail: { thumbnailSrc }
tags: [docker, linux]
draft: false
---

도커 네트워크 구성과 개념 그리고 명령어에 대해 알아봅시다.

## 컨테이너 통신 방법

### docker0

- virtual ethernet bridge: 외부 네트워크와 도커 컨테이너의 연결 다리 역할을 합니다.
  - 기본 네트워크 대역: `172.17.0.0/16` / docker0는 `172.17.0.1`를 통해서 게이트웨이 역할을 해줌
  - NAT(Network Address Translate), 포트포워딩 지원 - iptables를 통해서 지원해 줌
  - L2 통신기반
  - Container 생성 시 veth 인터페이스 생성(sandbox)

### 도커 네트워크 구성도

![1. 도커 네트워크구성](C:\Users\Nick\_주성우\OneDrive\바탕 화면\IT공부자료\이성미강사님\[따배도]\1. 도커 네트워크구성.png)

- `ip addr` 명령어를 통해 네트워크 카드 확인
  - eth0 - 호스트 이더넷, docker0 네트워크 확인 가능

![2. 아이피 확인](C:\Users\Nick\_주성우\OneDrive\바탕 화면\IT공부자료\이성미강사님\[따배도]\2. 아이피 확인.JPG)

## 컨테이너 포트를 외부에 노출하는 방법

- container port를 외부로 노출시켜 외부 연결을 허용해줄 수 있습니다.
- iptalbes rule을 통한 포트 노출 - 포트포워딩
  - `-p hostPort:containerPort`
  - `-p containerPort` : 이 경우 호스트 포트는 **random**
  - `-P` : EXPOSE로 맞춰진 random 한 값을 도커 네트워크 대역에서 설정
- 포트포워딩 예시 및 `iptables` 명령어를 통해 확인

```bash
$ docker run --name web -d -p 80:80 nginx:latest
$ iptables -t nat -L -nv
```

![3. iptables 명령어를 통해 확인](C:\Users\Nick\_주성우\OneDrive\바탕 화면\IT공부자료\이성미강사님\[따배도]\3. iptables 명령어를 통해 확인.JPG)

## 컨테이너 네트워크 추가하는 방법

### user-defined bridge network 생성

- 네트워크 대역을 사용자 정의 네트워크로 만들어서 연결이 가능합니다.
  - `docker network create` 명령어를 사용해서 만들 수 있습니다.

```bash
# --driver-brige : 네트워크 통신 방식 설정
# --subnet : 서브넷 설정
# --gateway : 게이트웨이 설정
# mynet : 사용자 정의 네트워크 이름
$ docker network create --driver-brige --subnet 192.168.100.0/24 --gateway 192.168.100.254 mynet
```

- 만들어진 네트워크를 사용하는 방법

```bash
# --net : 사용할 네트워크 지정
# --ip : 고정 ip주소 사용
$ docker run -d --name appjs --net mynet --ip 192.168.100.100 -p 8080:8080 swjoo/appjs`
```

## 컨테이너끼리 통신하는 방법

컨테이너간 통신이 필요할 때가 있는데 예를 들어서 프론트 단과 백엔드 단이 구성되어 있는 멀티 티어 같은 구조입니다. 프론트에서 만들어진 데이터를 백엔드에 저장하고 또는 데이터를 가져와서 사용해할 때 사용하게 됩니다. 이때 각각의 컨테이너가 독립적으로 운용된다고 하였을 때 컨테이너 간의 통신이 필요하므로 컨테이너 간의 통신이 필요하게 됩니다.

> 기본적으로 컨테이너는 서로 독립적인 격리 상태 구조입니다.

### 예시를 통해 알아봅시다.

- 워드프레스는 기본적으로 아파치 웹서버를 내장하고 있고 워드프레스를 이용하여 웹을 제작하려고 할 때, 데이터베이스가(백엔드 단)이 필요하게 됩니다.
- 데이터베이스 생성
  - `MYSQL_ROOT_PASSWORD`: mysql의 root 사용자 비밀번호
  - `MYSQL_PASSWORD` : 워드프레스가 사용하는 패스워드

```bash
$ docker run -d --name mysql -v /dbdata:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=wordpress -e MYSQL_PASSWORD=wordpress mysql:latest
```

- 워드프레스 생성
  - `--link` : 명령어를 통해 mysql 컨테이너와 연결
  - `mysql:mysql` : <연결할 컨테이너 명>:<이름 사용자 지정>
  - `-e WORDPRESS_DB_PASSWORD` : 워드프레스 db에 사용하는 패스워드(mysql 컨테이너에서 설정한 것)

```bash
$ docker run -d --name wordpress --link mysql:mysql -e WORDPRESS_DB_PASSWORD -p 80:80 wordpress:latest
```

해당 설정을 통해 호스트 `/dbdata path`에 데이터가 쌓이게 되고 프론트, 백엔드 단 설정이 완료됩니다.

## 실습

## Reference

[도커 네트워크 구성](https://joont92.github.io/docker/network-%EA%B5%AC%EC%A1%B0/)

[iptables 명령어](https://linuxstory1.tistory.com/entry/iptables-%EA%B8%B0%EB%B3%B8-%EB%AA%85%EB%A0%B9%EC%96%B4-%EB%B0%8F-%EC%98%B5%EC%85%98-%EB%AA%85%EB%A0%B9%EC%96%B4)

[도커 공식 레퍼런스](https://docs.docker.com/engine/reference/commandline/run/)
