---
title: '[ë”°ë°°ì¿ ] ì¿ ë²„ë„¤í‹°ìŠ¤ ì„¤ì¹˜, ë¹„ì„¤ì¹˜ ì‹¤ìŠµ'
date: 2021-02-16 00:22:30
category: 'ğŸ§­ Kubernetes'
thumbnail: { thumbnailSrc }
draft: false
---

- ì¹´íƒ€ì½”ë‹¤ ì¿ ë²„ë„¤í‹°ìŠ¤ í”Œë ˆì´ê·¸ë¼ìš´ë“œ
  - https://www.katacoda.com/courses/kubernetes/playground
  - Master, node1 êµ¬ì„±ë˜ì–´ ìˆì–´ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥(1ì‹œê°„)
- Play with Kubernetes
  - dockerì—ì„œ ì œê³µ, docker hub ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
  - https://labs.play-with-k8s.com/
  - 4ì‹œê°„ ì‚¬ìš© ê°€ëŠ¥. master, worker nodeë¥¼ ì§ì ‘ êµ¬ì„±í•œ í›„ ì‚¬ìš©ê°€ëŠ¥

# play with K8S

`ADD NEW INSTANCE` ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ì•„ë˜ì™€ ê°™ì€ ëª…ë ¹ì–´ í™•ì¸ ê°€ëŠ¥

```bash
1. Initializes cluster master node:

 kubeadm init --apiserver-advertise-address $(hostname -i) --pod-network-cidr 10.5.0.0/16


 2. Initialize cluster networking:

kubectl apply -f https://raw.githubusercontent.com/cloudnativelabs/kube-router/master/daemonset/kubeadm-kuberouter.yaml


 3. (Optional) Create an nginx deployment:

 kubectl apply -f https://raw.githubusercontent.com/kubernetes/website/master/content/en/examples/application/nginx-app.yaml
```

<img width="335" alt="2" src="https://user-images.githubusercontent.com/66216102/107961735-a6b6e800-6fe9-11eb-9f58-e4aa196b43e1.PNG">

- 1ë²ˆì˜ ëª…ë ¹ì–´ë¡œ ì»´í¬ë„ŒíŠ¸ë“¤ êµ¬ì„± ë° ë§ˆìŠ¤í„° ë…¸ë“œ ìƒì„±
  - ì»´í¬ë„ŒíŠ¸ë“¤ì˜ êµ¬ì„±ìš”ì†ŒëŠ” **API, Controller, schduler, etcd, CoreDNS** ê°€ ìˆë‹¤.
- ì„¤ì¹˜ ì´í›„ ì›Œì»¤ ë…¸ë“œë¥¼ ì¡°ì¸í•  ìˆ˜ ìˆëŠ” í‚¤ê°€ ì£¼ì–´ì§„ë‹¤. (ë§¤ìš° ì¤‘ìš”)
- 2ë²ˆì˜ ëª…ë ¹ì–´ë¡œ ë„¤íŠ¸ì›Œí¬ë¥¼ ì´ˆê¸°í™” í•˜ëŠ” ëª…ë ¹ì–´ì´ë‹¤. ë„¤íŠ¸ì›Œí¬ë¥¼ êµ¬ì„±í•œë‹¤.
- ì›Œì»¤ ë…¸ë“œë¥¼ í•˜ë‚˜ ë” ìƒì„± í›„ ì•„ê¹Œ ë´¤ë˜ ì›Œì»¤ ë…¸ë“œë¥¼ ì¡°ì¸í•  ìˆ˜ ìˆëŠ” í‚¤ë¥¼ ê·¸ëŒ€ë¡œ ì›Œì»¤ë…¸ë“œì— ë³µì‚¬/ë¶™ì—¬ë„£ê¸°
  - ì›Œì»¤ë…¸ë“œì— í•„ìš”í•œ ì»´í¬ë„ŒíŠ¸ë“¤ì„ êµ¬ì„±í•œë‹¤.
- `kubectl get nodes -o wide` ëª…ë ¹ì–´ë¡œ í´ëŸ¬ìŠ¤í„° êµ¬ì„±ì„ í™•ì¸
- ëª¨ë“  ì¿ ë²„ë„¤í‹°ìŠ¤ ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆë‹¤.

# í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ì—ì„œ ì œê³µí•˜ëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ ë„êµ¬

- êµ¬ê¸€ ì¿ ë²„ë„¤í‹°ìŠ¤ ì—”ì§„(GKE)
- ì•„ë§ˆì¡´ ì¿ ë²„ë„¤í‹°ìŠ¤ ì¼ë˜ìŠ¤í‹± ì»¨í…Œì´ë„ˆ ì„œë¹„ìŠ¤(EKS)
- ì• ì € ì¿ ë²„ë„¤í‹°ìŠ¤ ì„œë¹„ìŠ¤(AKS)

# ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„°ë¥¼ ì§ì ‘ êµ¬ì„±í•˜ëŠ” ë„êµ¬

- kubeadm
  - ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„œ ê³µì‹ ì œê³µí•˜ëŠ” í´ëŸ¬ìŠ¤í„° ìƒì„±/ê´€ë¦¬ ë„êµ¬
- kubespray
  - ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„°ë¥¼ ë°°í¬í•˜ëŠ” ì˜¤í”ˆì†ŒìŠ¤ í”„ë¡œì íŠ¸
  - ë‹¤ì–‘í•œ í˜•ì‹ìœ¼ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„° êµ¬ì„±ê°€ëŠ¥
  - ì˜¨í”„ë ˆë¯¸ìŠ¤ì—ì„œ ìƒìš© ì„œë¹„ìŠ¤ í´ëŸ¬ìŠ¤í„° ìš´ì˜ì‹œ ìœ ìš©
  - ë‹¤ì–‘í•œ CNI ì œê³µ

# CNI (Container Network Interface)

- Containerê°„ í†µì‹ ì„ ì§€ì›í•˜ëŠ” `VxLAN`, `Pod Network`ë¼ê³ ë„ ë¶€ë¦„
- ë‹¤ì–‘í•œ ì¢…ë¥˜ì˜ í”Œë¡œê·¸ ì¸ì´ ì¡´ì¬
  - í”Œë¼ë„¬(flannel)
  - ì¹¼ë¦¬ì½”(calico)
  - ìœ„ë¸Œë„·(weavenet) ë“±ë“±

# ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„° êµ¬ì„±

- control plane(master node)
  - ì›Œì»¤ ë…¸ë“œë“¤ì˜ ìƒíƒœë¥¼ ê´€ë¦¬í•˜ê³  ì œì–´
  - single master
  - multi master(3, 5ê°œì˜ master nodes)
- worker node
  - ë„ì»¤ í”Œë«í¼ì„ í†µí•´ ì»¨í…Œì´ë„ˆë¥¼ ë™ì‘í•˜ë©° ì‹¤ì œ ì„œë¹„ìŠ¤ ì œê³µ

# ì¿ ë²„ë„¤í‹°ìŠ¤ ì§ì ‘ ì„¤ì¹˜

1. ëª¨ë“  ê°€ìƒë¨¸ì‹  ì‹œì‘(docker ì„¤ì¹˜ë˜ì–´ìˆì–´ì•¼ í•¨)
2. kubeadm íˆ´ì„ ì´ìš©í•´ ì¿ ë²„ë„¤í‹°ìŠ¤ ì„¤ì¹˜ [ì¿ ë²„ë„¤í‹°ìŠ¤ ê³µí™ˆ](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/)
   - ìµœì†Œ ì‚¬ì–‘ ë“±ì„ í™•ì¸
3. ë£¨íŠ¸ ê³„ì • ì „í™˜ & Swap disabled

```bash
$ su -
# swapoff -a && sed -i '/swap/s/^/#/' /etc/fstab
```

4. [Letting iptables see bridged traffic](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#letting-iptables-see-bridged-traffic)(ë¸Œë¦¿ì§€ ë„¤íŠ¸ì›Œí¬ Listenì´ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •)

```bash
cat <<EOF | tee /etc/modules-load.d/k8s.conf
br_netfilter
EOF

cat <<EOF | tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF
sysctl --system
```

5. Check required ports & Disable firewall

```bash
# systemctl stop firewalld
# systemctl disable firewalld
```

6. Installing runtime
   - ë„ì»¤ ì„¤ì¹˜ ì™„ë£Œ, ë™ì‘ ì¤‘
7. Installing kubeadm, kubelet and kubectl
   - `kubeadm`: ì¿ ë²„ë„¤í‹°ìŠ¤ ì „ì²´ë¥¼ ê´€ë¦¬í•˜ê³  ìš´ì˜í•´ì£¼ëŠ” ëª…ë ¹ì–´
   - `kubelet`: ë°ëª¬(ì»¨í…Œì´ë„ˆ ì¡°ì‘ ë° ë§ˆìŠ¤í„°ì™€ í†µì‹ í•  ë•Œ ì‚¬ìš©)
   - `kubectl`: ì£¼ìš” ëª…ë ¹ì–´

```bash
apt-get update && apt-get install -y apt-transport-https curl
curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -
cat <<EOF | tee /etc/apt/sources.list.d/kubernetes.list
deb https://apt.kubernetes.io/ kubernetes-xenial main
EOF
apt-get update
apt-get install -y kubelet kubeadm kubectl
apt-mark hold kubelet kubeadm kubectl
```

# control-plane êµ¬ì„±

1. ì„œë¹„ìŠ¤ ì‹œì‘ ë° ìë™ ì‹œì‘ ì„¤ì •

```bash
systemctl start kubelet
systemctl enable kubelet
```

2. control-plane ë…¸ë“œ ì‹¤í–‰

```bash
kubeadm init
```

- ì¿ ë²„ë„¤í‹°ìŠ¤ì˜ ì»´í¬ë„ŒíŠ¸ë“¤ì´ ìƒì„±ëœë‹¤.

  - API, controller, scduler, etcd

- ì„¤ì¹˜ ì´í›„ í† í° ì €ì¥

```bash
cat > token.txt
```

- ë³µì‚¬ ë¶™ì—¬ ë„£ê¸° ì´í›„ `ctrl + d`

3. kubectl ëª…ë ¹ ì‚¬ìš©í—ˆê°€ ì„¤ì •

```bash
exit

mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

4. ëª…ë ¹ì˜ ì†Œìœ ê¶Œì„ ë£¨íŠ¸ ê³„ì •ì´ ì•„ë‹Œ **ê´€ë¦¬ì ê³„ì •ì— ë¶€ì—¬**

```bash
sudo chown $(id -u):$(id -g) $HOME/.kube/config
kubectl get nodes ê´€ë¦¬ì ê³„ì •ìœ¼ë¡œ ëª…ë ¹ì–´ ë˜ëŠ”ì§€ í™•ì¸
```

ì´ ìƒíƒœê¹Œì§€ ë”°ë¼ì˜¨ë‹¤ë©´, kubectl get nodes ëª…ë ¹ì–´ë¥¼ ì…ë ¥í–ˆì„ ë•Œ, master ë…¸ë“œê°€ `NotReady` ìƒíƒœë¡œ ë‚˜ì˜¬í…ë°, CNIê°€ ë¯¸ì„¤ì¹˜ ëœ ìƒíƒœë¼ì„œ ê·¸ë ‡ë‹¤. ë°‘ì˜ ëª…ë ¹ì–´ë¥¼ ì„¤ì¹˜í•œ í›„ ì ì‹œ ê¸°ë‹¤ë ¤ë³´ë©´ Ready ìƒíƒœë¡œ ë°”ë€” ìˆ˜ ìˆë‹¤.

5. pod network add-on (CNI ì„¤ì¹˜ - weavenet)

```bash
kubectl apply -f "https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d '\n')"

kubectl get nodesë¡œ Ready ìƒíƒœë¥¼ í™•ì¸
```

# worker ë…¸ë“œ êµ¬ì„±

ì›Œì»¤ ë…¸ë“œë¥¼ ë§ˆìŠ¤í„° ë…¸ë“œì™€ Join ì‹œì¼œì•¼í•œë‹¤.

1. ì•„ê¹Œ ë°œê¸‰ ë°›ì•˜ë˜ token.txtë¥¼ ê° ë…¸ë“œì— ë¶™ì—¬ë„£ê¸° í›„ í™•ì¸

<img width="1100" alt="ìº¡ì²˜" src="https://user-images.githubusercontent.com/66216102/108671982-a5734700-7524-11eb-9532-f67d7677a951.PNG">

# TIP - bashì°½ì— TABí‚¤ ì´ìš© ê°€ëŠ¥í•˜ê²Œ í•˜ê¸°

ì¿ ë²„ë„¤í‹°ìŠ¤ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ Bash ìë™ì™„ì„±ì„ ì§€ì›í•´ì£¼ê³  ìˆì§€ì•Šë‹¤. ì¿ ë²„ë„¤í‹°ìŠ¤ ê³µì‹í™ˆí˜ì´ì§€ì—ì„œ `bash completion` ê²€ìƒ‰ í›„ **kubectl ì¹˜íŠ¸ ì‹œíŠ¸ ì ‘ì†**

```bash
# bash-completion íŒ¨í‚¤ì§€ë¥¼ ë¨¼ì € ì„¤ì¹˜í•œ í›„, bashì˜ ìë™ ì™„ì„±ì„ í˜„ì¬ ì…¸ì— ì„¤ì •í•œë‹¤
source <(kubectl completion bash)
# ìë™ ì™„ì„±ì„ bash ì…¸ì— ì˜êµ¬ì ìœ¼ë¡œ ì¶”ê°€í•œë‹¤
echo "source <(kubectl completion bash)" >> ~/.bashrc
```

- kubectlë¥¼ kubeadmìœ¼ë¡œ ë°”ê¾¸ë©´ kubeadmë„ íƒ­í‚¤ê°€ ê°€ëŠ¥í•˜ë‹¤.
