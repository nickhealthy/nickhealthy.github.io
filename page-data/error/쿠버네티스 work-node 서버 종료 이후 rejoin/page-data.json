{"componentChunkName":"component---src-templates-blog-post-js","path":"/error/쿠버네티스 work-node 서버 종료 이후 rejoin/","result":{"data":{"site":{"siteMetadata":{"title":"Woo's Dev Log","author":"nickhealthy","siteUrl":"https://nickhealthy.github.io","comment":{"disqusShortName":"","utterances":"nickhealthy/nickhealthy.github.io"},"sponsor":{"buyMeACoffeeId":""}}},"markdownRemark":{"id":"2782f72a-32ca-5c0d-ad9e-fc42234f3fdc","excerpt":"문제발생 클라우드 서버를 이용해서 쿠버네티스를 구축했는데, 클라우드 서비스의 이용 가격 때문에 워커노드를 종료시켰습니다. 하지만 워커노드를 재시작하였을 때, 컨트롤 플래인(마스터 노드)랑 연결이 안되는 문제가 있었습니다. 이를 해결한 방법을 잊지 않기 위해 적어봅니다. 1  masterNode 확인 해결방안 마스터노드에서 진행 현재 조인되어 있는 워커노드들을 삭제 현재 조인이 가능한 토큰 확인 토큰 생성 토큰 값을 해쉬 값으로 변경 쿠버네티스 공식 홈페이지 참조…","html":"<h2 id=\"문제발생\" style=\"position:relative;\"><a href=\"#%EB%AC%B8%EC%A0%9C%EB%B0%9C%EC%83%9D\" aria-label=\"문제발생 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>문제발생</h2>\n<ul>\n<li>클라우드 서버를 이용해서 쿠버네티스를 구축했는데, 클라우드 서비스의 이용 가격 때문에 워커노드를 종료시켰습니다. 하지만 워커노드를 재시작하였을 때, 컨트롤 플래인(마스터 노드)랑 연결이 안되는 문제가 있었습니다. <strong><u>이를 해결한 방법을 잊지 않기 위해 적어봅니다.</u></strong></li>\n</ul>\n<p><img src=\"https://user-images.githubusercontent.com/66216102/135989726-b02faeca-519f-4dc5-83bd-04fe0708b10f.JPG\" alt=\"1  masterNode 확인\"></p>\n<h2 id=\"해결방안\" style=\"position:relative;\"><a href=\"#%ED%95%B4%EA%B2%B0%EB%B0%A9%EC%95%88\" aria-label=\"해결방안 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>해결방안</h2>\n<h3 id=\"마스터노드에서-진행\" style=\"position:relative;\"><a href=\"#%EB%A7%88%EC%8A%A4%ED%84%B0%EB%85%B8%EB%93%9C%EC%97%90%EC%84%9C-%EC%A7%84%ED%96%89\" aria-label=\"마스터노드에서 진행 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>마스터노드에서 진행</h3>\n<ol>\n<li>현재 조인되어 있는 워커노드들을 삭제</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ kubectl delete nodes <span class=\"token punctuation\">[</span>워커노드 이름<span class=\"token punctuation\">]</span></code></pre></div>\n<ol start=\"2\">\n<li>현재 조인이 가능한 토큰 확인</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ kubeadm token list</code></pre></div>\n<ol start=\"3\">\n<li>토큰 생성</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ kubeadm token create</code></pre></div>\n<ol start=\"4\">\n<li>\n<p>토큰 값을 해쉬 값으로 변경</p>\n<ul>\n<li><a href=\"https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-join/\">쿠버네티스 공식 홈페이지 참조</a></li>\n</ul>\n</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt <span class=\"token operator\">|</span> openssl rsa -pubin -outform der <span class=\"token operator\"><span class=\"token file-descriptor important\">2</span>></span>/dev/null <span class=\"token operator\">|</span> openssl dgst -sha256 -hex <span class=\"token operator\">|</span> <span class=\"token function\">sed</span> <span class=\"token string\">'s/^.* //'</span></code></pre></div>\n<p><img src=\"https://user-images.githubusercontent.com/66216102/135989733-a01de6d2-27bf-4d13-a909-413a885b9ffb.JPG\" alt=\"2  토큰생성\"></p>\n<h3 id=\"워커노드에서-진행\" style=\"position:relative;\"><a href=\"#%EC%9B%8C%EC%BB%A4%EB%85%B8%EB%93%9C%EC%97%90%EC%84%9C-%EC%A7%84%ED%96%89\" aria-label=\"워커노드에서 진행 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>워커노드에서 진행</h3>\n<ol>\n<li>기존에 연결된 클러스터를 리셋</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ kubeadm reset\n<span class=\"token comment\"># \"y\" 입력</span></code></pre></div>\n<p><img src=\"https://user-images.githubusercontent.com/66216102/135989735-1bef8c4a-b7b4-454b-8e44-8efd90ed124e.JPG\" alt=\"3  쿠버네티스 리셋\"></p>\n<ol start=\"2\">\n<li>리셋 후 메뉴얼에 따라 환경설정 파일도 모두 삭제</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">rm</span> -rf <span class=\"token environment constant\">$HOME</span>/.kube/</code></pre></div>\n<p><img src=\"https://user-images.githubusercontent.com/66216102/135989736-d967a30f-19a3-4426-9879-cd4654aba519.JPG\" alt=\"3-1  쿠버네티스 리셋\"></p>\n<ol start=\"3\">\n<li><code class=\"language-text\">free</code> 명령어로 swap 메모리 사용중인지 확인 및 swap 사용 중지</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># swap 메모리 확인</span>\n$ <span class=\"token function\">free</span>\n<span class=\"token comment\"># swap 메모리 중지</span>\n$ swapoff -a</code></pre></div>\n<ol start=\"4\">\n<li>\n<p><code class=\"language-text\">kubeadm</code> 명령어로 쿠버네티스 클러스터 조인하기</p>\n<ul>\n<li>kubeadm join —discovery-token [토큰명] —discovery-token-ca-cert-hash sha256:[해쉬값 ][마스터 노드ip주소:포트번호]</li>\n<li>IP주소를 확인하는 방법은 <code class=\"language-text\">ifconfig</code> 명령어로 <em>eth0</em> 네트워크 카드 주소를 확인하면 됨</li>\n<li>6443 포트 : Kubernetes API Server / Used By All - 마스터노드에서 필수적으로 사용해야 하는 포트번호</li>\n</ul>\n</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">kubeadm <span class=\"token function\">join</span> --discovery-token m5j2gy.cjmczii6g5ivsu77 --discovery-token-ca-cert-hash sha256:cafed3e44fafa2b149dd00dbef6752ce3bb2c422be91e4478d04ac59e9c38db8 <span class=\"token number\">172.27</span>.0.126:6443</code></pre></div>\n<ol start=\"5\">\n<li>검증 - 워커노드가 정상적으로 연결됨</li>\n</ol>\n<p><img src=\"https://user-images.githubusercontent.com/66216102/135989740-83533031-89dc-46b0-abf2-8512655beae0.JPG\" alt=\"4  확인\"></p>\n<h2 id=\"번외---reference\" style=\"position:relative;\"><a href=\"#%EB%B2%88%EC%99%B8---reference\" aria-label=\"번외   reference permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>번외 - reference</h2>\n<blockquote>\n<p><a href=\"https://medium.com/finda-tech/overview-8d169b2a54ff\">블로그 글</a></p>\n<p>쿠버네티스가 사용하는 포트번호를 검색하다가 상세하게 설명한 좋은 블로그 글이 있어서 참조함</p>\n</blockquote>\n<h4 id=\"마스터-노드에서는-6443-23792380-10250-10251-10252-포트가-사용되고-있지-않아야-한다\" style=\"position:relative;\"><a href=\"#%EB%A7%88%EC%8A%A4%ED%84%B0-%EB%85%B8%EB%93%9C%EC%97%90%EC%84%9C%EB%8A%94-6443-23792380-10250-10251-10252-%ED%8F%AC%ED%8A%B8%EA%B0%80-%EC%82%AC%EC%9A%A9%EB%90%98%EA%B3%A0-%EC%9E%88%EC%A7%80-%EC%95%8A%EC%95%84%EC%95%BC-%ED%95%9C%EB%8B%A4\" aria-label=\"마스터 노드에서는 6443 23792380 10250 10251 10252 포트가 사용되고 있지 않아야 한다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>마스터 노드에서는 6443, 2379~2380, 10250, 10251, 10252 포트가 사용되고 있지 않아야 한다.</h4>\n<ul>\n<li><a href=\"https://www.notion.so/1076e23a862f4fd79d69d51f23644ac3\">마스터 노드에서 필요한 필수 포트</a></li>\n<li>6443 포트 : Kubernetes API Server / Used By All</li>\n<li>2379~2380 포트 : etcd server client API / Used By kube-apiserver, etcd</li>\n<li>10250 포트 : Kubelet API / Used By Self, Control plane</li>\n<li>10251 포트 : kube-scheduler / Used By Self</li>\n<li>10252 포트 : kube-controller-manager / Used By Self</li>\n</ul>\n<h4 id=\"워커-노드에서는-10250-3000032767-포트가-사용되고-있지-않아야-한다\" style=\"position:relative;\"><a href=\"#%EC%9B%8C%EC%BB%A4-%EB%85%B8%EB%93%9C%EC%97%90%EC%84%9C%EB%8A%94-10250-3000032767-%ED%8F%AC%ED%8A%B8%EA%B0%80-%EC%82%AC%EC%9A%A9%EB%90%98%EA%B3%A0-%EC%9E%88%EC%A7%80-%EC%95%8A%EC%95%84%EC%95%BC-%ED%95%9C%EB%8B%A4\" aria-label=\"워커 노드에서는 10250 3000032767 포트가 사용되고 있지 않아야 한다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>워커 노드에서는 10250, 30000~32767 포트가 사용되고 있지 않아야 한다.</h4>\n<ul>\n<li><a href=\"https://www.notion.so/6fc66804433d494187d8bce9b041b63c\">워커 노드에서 필요한 필수 포트</a></li>\n<li>10250 포트 : Kubelet API / Used By Self, Control plane</li>\n<li>30000~32767 포트 : NodePort Services / Used By All</li>\n</ul>\n<h4 id=\"스왑-메모리-비활성화\" style=\"position:relative;\"><a href=\"#%EC%8A%A4%EC%99%91-%EB%A9%94%EB%AA%A8%EB%A6%AC-%EB%B9%84%ED%99%9C%EC%84%B1%ED%99%94\" aria-label=\"스왑 메모리 비활성화 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>스왑 메모리 비활성화</h4>\n<ul>\n<li>서버를 끄지 않고 계속 사용한다면 <code class=\"language-text\">swapoff -a</code>의 명령어도 충분하지만, 매번 껐다 켜야 할 경우 아래의 명령어를 추천</li>\n<li><em>/etc/fstab</em> 파일은 해당 서버가 사용하는 스토리지에 대한 정보를 작성하는 곳으로 <strong><u>루트 파티션의 정보가 들어있는 정보를 주석으로 처리할 시 서버가 먹통이 될 수 있으므로 매우 조심</u></strong></li>\n<li>아래의 명령어는 1번째 줄의 명령어 앞에 #(주석)를 붙이는 명령어임</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">sed</span> -i <span class=\"token string\">'1s/^/#/'</span> /etc/fstab</code></pre></div>","frontmatter":{"title":"쿠버네티스 work-node 서버 종료 이후 rejoin","date":"October 05, 2021","category":"🤔 error"}}},"pageContext":{"slug":"/error/쿠버네티스 work-node 서버 종료 이후 rejoin/","previous":{"fields":{"slug":"/devops/KOSTA_Ansible을 이용한 AWS 클라우드 DevOps 자동화 구현-4/"},"frontmatter":{"title":"KOSTA_Ansible을 이용한 AWS 클라우드 DevOps 자동화 구현-4","category":"⛓️ devops","draft":false}},"next":null}},"staticQueryHashes":["3128451518","521680639"]}